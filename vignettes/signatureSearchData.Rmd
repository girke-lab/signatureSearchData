---
title: _signatureSearchData_ - Annotation data package for _signatureSearch_
      software package
author: "Author: Yuzhu Duan (yduan004@ucr.edu)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    toc: true
    toc_float:
        collapsed: true
        smooth_scroll: true
    toc_depth: 4
    fig_caption: yes
    code_folding: show
    number_sections: true
  pdf_document:
    toc: true
fontsize: 15pt
vignette: >
  %\VignetteIndexEntry{signatureSearchData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>

```{r setup, echo=FALSE, messages=FALSE, warnings=FALSE}
suppressPackageStartupMessages({
    library(signatureSearchData)
})
```

# Introduction
This is an annotation data package for `signatureSearch` software package. It
stores the CMAP/LINCS reference databases used for GESS methods in the
`signatureSearch` package as well as other intermediate datasets.

# Installation and Loading

`signatureSearch` is a R/Bioconductor package and can be installed through 
`BiocManager::install()`
```{r install, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("signatureSearchData", version = "3.9")
```

After the package is installed, it can be loaded into \emph{R} workspace by
```{r load, eval=TRUE}
library(signatureSearchData)
```

# `cmap` signature database
The `cmap` database represents the $log_2$ fold change (log2FC) of 12,403 genes 
from 1,281 compound treatments in 4 cells (3,478 signatures in total). 
The log2FC matrix is stored in HDF5 file and can be loaded through the 
`AnnotationHub` interface
```{r cmap, eval=FALSE}
library(AnnotationHub)
ah <- AnnotationHub()
qr <- query(ah, c("signatureSearchData", "cmap"))
qr
cmap <- load_sigdb("AH69075","AH69076","cmap")
```

## Generate the `cmap` database from the original resources
The source data was downloaded from the 
[Connectivity Map](https://portals.broadinstitute.org/cmap/) project, 
which is the CEL files generated by Affymetrix chips. 
The downloaded CEL files were normalized by `MAS5` method. 
Then the `limma` package was used to do the differential expression (DE)
analysis to get the `logMA` matrix containing the log2 fold change scores. 
The `logMA` matrix was stored in an HDF5 file, which is the `cmap` database.
The following steps were used to generate the `cmap` database.

### Create expected directory structure
The following creates the expected directory structure. Input data will be 
stored in the data directory and results will be written to the results 
directory. All paths are given relative to the present working directory of 
the user’s R session.
```{r work_envir, eval=FALSE}
dir.create("data"); dir.create("data/CEL"); dir.create("results") 
```

### Download data from Connectivity Map project site
The drug-related expression data are downloaded from the CMAP web site
[here](http://www.broadinstitute.org/cmap). The `getCmapCEL` function
downloads the 7,056 CEL files. The functions will write the
downloaded files to the `data/CEL` directories within the present 
working directory of the user's R session. Since some of the raw data sets 
are large, the functions will only rerun the download if the argument `rerun` 
is assigned `TRUE`. If the raw data are not needed then users can skip this 
time consuming download step and work with the preprocessed data 
obtained in the next section.

```{r download_cmap, eval=FALSE}
getCmapCEL(rerun=FALSE) # Download cmap CEL files. this will take hours
```

The experimental design of the CMAP project is defined in the file
`cmap_instances_02.xls`.  Note, this file required some cleaning in LibreOffice
(Excel would work for this too). After this it was saved as tab delimited txt
file named `cmap_instances_02.txt`. It is available from this package.
```{r cmap_inst2, eval=TRUE}
path <- system.file("extdata", "cmap_instances_02.txt", package="signatureSearchData")
cmap_inst <- read.delim(path, check.names=FALSE) 
```

The panel of cell lines used by CMAP includes 
[MCF7](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#mcf7), 
[ssMCF7](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#mcf7), 
[HL60](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#hl60), 
[PC3](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#pc3) and 
[SKMEL5](http://www.broadinstitute.org/cmap/help_topics_linkified.jsp#skmel5). 

### Determine chip type from CEL files 
The CMAP data set is based on three different Affymetrix chip types (HG-U133A,
HT_HG-U133A and U133AAofAv2). The following extracts the chip type information
from the CEL files and stores the result in an `rds` file with the path 
`./data/chiptype.rds`.

```{r get_cel_type, eval=FALSE}
library(affxparser)
celfiles <- list.files("./data/CEL", pattern=".CEL$")
chiptype <- sapply(celfiles, function(x) affxparser::readCelHeader(paste0("data/CEL/", x))$chiptype)
saveRDS(chiptype, "./data/chiptype.rds")
```

### Normalization of CEL files

The following processes the CEL files from each chip type separately using the
MAS5 normalization algorithm. The results will be written to 3 subdirectores
under `data` that are named after the chip type names. To save time, the
processing is paralleled with `batchtools` to normalize 100 CEL files in
one batch run on 100 CPU cores of a
computer cluster with a scheduler (_e.g._ Slurm). The number of CEL files from
each chip type are: 807 CEL files from HG-U133A, 6029 CEL files from
HT_HG-U133A, and 220 CEL files from U133AAofAv2. Note, these numbers are slightly
different than those reported in the `cmap_instances_02.txt` file. 

```{r normalize_chips, eval=FALSE}
chiptype <- readRDS("./data/chiptype.rds")
chiptype_list <- split(names(chiptype), as.character(chiptype))
normalizeCel(chiptype_list, rerun=FALSE)
```

Combine results from same chip type in single data frame
```{r comb_chip_type_data, eval=FALSE}
chiptype_dir <- unique(readRDS("./data/chiptype.rds"))
combineResults(chiptype_dir, rerun=FALSE)
```

### Clean-up of intermediate files

This deletes intermediate files. Before executing these lines, 
please make sure that this is what you want.

```{r cleanup1, eval=FALSE}
for(i in seq_along(chiptype_dir)) 
    unlink(list.files(paste0("data/", chiptype_dir[i]), pattern="cellbatch", 
                      full.names=TRUE), recursive=TRUE)
unlink("data/CEL/*.CEL") # Deletes downloaded CEL files
```

### Obtain annotation information
The following generates annotation information for the Affymetirx probe set
identifiers. Note, the three different Affymetrix chip types used by CMAP
share most probe set ids (>95%), meaning it is possible to combine the data
after normalization and use the same annotation package for all of them. The
annotation libraries for the chip types HG-U133A and HT_HG-U133A are
`hgu133a.db` and `hthgu133a.db`, respectively. However, there is no annotation 
library (e.g. CDF) available for U133AAofAv2.

```{r affyid_annotations, eval=FALSE, message=FALSE}
library(hgu133a.db)
myAnnot <- data.frame(ACCNUM=sapply(contents(hgu133aACCNUM), paste, collapse=", "), 
                             SYMBOL=sapply(contents(hgu133aSYMBOL), paste, collapse=", "), 
                             UNIGENE=sapply(contents(hgu133aUNIGENE), paste, collapse=", "), 
                             ENTREZID=sapply(contents(hgu133aENTREZID), paste, collapse=", "), 
                             ENSEMBL=sapply(contents(hgu133aENSEMBL), paste, collapse=", "), 
                             DESC=sapply(contents(hgu133aGENENAME), paste, collapse=", "))
saveRDS(myAnnot, "./results/myAnnot.rds")
```

### DEG analysis with `limma`

#### Generate list of CEL names defining treatment vs. control comparisons

The `sampleList` function extracts the sample comparisons (contrasts) from the
CMAP annotation table and stores them as a list.

```{r cel_file_list, eval=FALSE}
path <- system.file("extdata", "cmap_instances_02.txt", package="signatureSearchData")
cmap_inst <- read.delim(path, check.names=FALSE) 
comp_list <- sampleList(cmap_inst, myby="CMP_CELL")
```

#### Load normalized expression data 

The following loads the MAS5 normalized expression data into a single `data.frame`. 
To accelerate the import, the data is read from `rds` files. 

```{r load_mas5_data, eval=FALSE}
chiptype_dir <- unique(readRDS("./data/chiptype.rds"))
mas5df <- combineNormRes(chiptype_dir, norm_method="MAS5")
```

#### Transform probe set to gene level data
The next step generates gene level expression values. If genes are represented by several
probe sets then their mean intensities are used. This is necessary because 
the U133 chip contains many genes with duplicated probe sets. Probe sets not matching 
any gene are removed.

```{r mean_mas5_data, eval=FALSE} 
myAnnot <- readRDS("./results/myAnnot.rds") 
mas5df <- probe2gene(mas5df, myAnnot)
saveRDS(mas5df, "./data/mas5df.rds")
```

#### DEG analysis with `limma`

The analysis of differentially expressed genes (DEGs) is performed with the `limma` package.
The log2 fold change (log2FC) scores of drug treatments in cells are used as 
gene expression profiles (GEPs). The log2FC matrix (`logMA`) is contained in the 
generated `degList`.

```{r deg_limma, eval=FALSE}
mas5df <- readRDS("./data/mas5df.rds")
degList <- runLimma(df=log2(mas5df), comp_list, fdr=0.10, foldchange=1, verbose=TRUE)
saveRDS(degList, "./results/degList.rds") # saves entire degList
```

### Store the `logMA` into an HDF5 file
The generated HDF5 file is the `cmap` database storing the log2FC scores of 
compound treatments in cells.
```{r se, eval=FALSE}
degList <- readRDS("./results/degList.rds")
logMA <- degList$logFC
## match colnames of logMA to '(drug)__(cell)__(factor)' format
colnames(logMA) <- gsub("(^.*)_(.*$)", "\\1__\\2__trt_cp", colnames(logMA)) 
matrix2h5(logMA, "./data/cmap.h5", overwrite=TRUE) # 12403 X 3478
## Read in cmap.h5 by chunks
cmap_se <- readHDF5chunk("./data/cmap.h5", colindex=1:5)
```

# `cmap_expr` signature database
For correlation based GESS methods (`gess_cor`) in the `signatureSearch` software 
package, the signature database containing gene expression intensity values of drug 
treatment samples could also be used to search for similarity when the query
signature are also gene expression values. 

The `cmap_expr` database represents mean expression values of 1,309 drug
treatment samples in 4 cells (3,587 signatures in total).
It is stored an HDF5 file and can be loaded through the `AnnotationHub` interface
```{r cmap_expr, eval=FALSE}
library(AnnotationHub)
ah <- AnnotationHub()
qr <- query(ah, c("signatureSearchData", "cmap_expr"))
cmap_expr <- load_sigdb("AH69077","AH69078","cmap_expr")
```

## Generate the `cmap_expr` database from the original resources
The same as the `cmap` database, the source data was downloaded from the 
[Connectivity Map](https://portals.broadinstitute.org/cmap/) project. 
The gene expression intensity data was rma normalized. Then, the mean expression 
values of drug treatment samples at different concentration, duration was used
as expression values of that drug in a cell type. The expression matrix
was saved in an HDF5 file (cmap_expr database).

### Normalization of CEL files with rma method
Use the same work environment as preparing the `cmap` database. Since the rma 
algorithm normalize all the CEL files at once, the normalization step requires 
large number of memory, 400GB works. 
```{r norm_rma, eval=FALSE}
chiptype <- readRDS("./data/chiptype.rds") 
chiptype_list <- split(names(chiptype), as.character(chiptype))
normalizeCel_rma(chiptype_list, rerun=FALSE) 
rmadf <- combineNormRes(unique(chiptype), norm_method="rma")
```

### Transform probe set to gene level data
```{r prof2gene, eval=FALSE}
myAnnot <- readRDS("./results/myAnnot.rds") 
rmadf <- probe2gene(rmadf, myAnnot)
saveRDS(rmadf,"./data/rmadf.rds")
```

### Take mean expression values of drug treatment samples

Take mean expression values of multiple drug treatment samples at different 
concentration and duration in the same cell as expression value of that drug
treatment in the cell.
```{r rma2cmap_expr, eval=FALSE}
rmadf <- readRDS("./data/rmadf.rds") # matrix: 12403 7056
path <- system.file("extdata", "cmap_instances_02.txt", package="signatureSearchData")
cmap_inst <- read.delim(path, check.names=FALSE) 
cmap_drug_cell_expr <- meanExpr(rmadf, cmap_inst) # 12403 X 3587
saveRDS(cmap_drug_cell_expr, "./data/cmap_drug_cell_expr.rds")
```

### Generate `cmap_expr` database from the expression matrix
```{r gen_cmap_expr, eval=FALSE}
cmap_drug_cell_expr <- readRDS("./data/cmap_drug_cell_expr.rds")
## match colnames to '(drug)__(cell)__(factor)' format
colnames(cmap_drug_cell_expr) <- gsub("(^.*)_(.*$)", "\\1__\\2__trt_cp", 
                                      colnames(cmap_drug_cell_expr)) 
matrix2h5(cmap_drug_cell_expr, "./data/cmap_expr.h5", overwrite=TRUE)
## Read in cmap_expr.h5 by chunks
cmap_expr_se <- readHDF5chunk("./data/cmap_expr.h5", colindex=1:5)
```

# `lincs` signature database
The `lincs` database represents moderated z-scores from DE analysis of 12,328 
genes from 8,140 compound treatments in 30 cells (45,956 signatures in total). 
It can be loaded through the `AnnotationHub` interface

```{r lincs, eval=FALSE}
library(AnnotationHub)
ah <- AnnotationHub()
qr <- query(ah, c("signatureSearchData", "lincs"))
lincs <- load_sigdb("AH69079","AH69080","lincs")
```

## Generate the `lincs` database from the original resources

The original LINCS Level 5 moderated z-score database was downloaded at [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742). 
The downloaded `gctx` file was processed and saved as HDF5 file.

### Download the original LINCS Level5 datasets at GEO 

Download the following files from [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742):

+ GSE92742_Broad_LINCS_Level5_COMPZ.MODZ_n473647x12328.gctx.gz
+ GSE92742_Broad_LINCS_gene_info.txt.gz
+ GSE92742_Broad_LINCS_sig_info.txt.gz
+ GSE92742_Broad_LINCS_cell_info.txt.gz

Unzip the downloaded files to the `data` directory under the present working 
directory of the user’s R session.

The LINCS Level5 signatures represent moderated z-scores of compound treatments
at different concentration and time in different cells from differential expression
analysis, the replicates have been weighted averaged.

### Filter signatures 

Filter lincs level5 signatures at specific concentration and treatment time 
and eliminate technical duplicates
```{r filter_meta42, eval=FALSE}
## ignore warning message
meta42 <- readr::read_tsv("./data/GSE92742_Broad_LINCS_sig_info.txt") 
dose <- meta42$pert_idose[7]
## filter rows by compound, 10 uM concentration, and 24 h treatment time
meta42_filter <- sig_filter(meta42, dose=dose, time="24 h") # 45956 X 14
```

### Save z-score matrix from gctx file to HDF5 file 

Read in the large z-score matrix of treatments after filter from the gctx file by chunks
and write the matrix to an HDF5 file, which is the `lincs` database.
Since the size of the matrix would be tens of gigabytes, 
it will consume all the memories of a laptop if reading the 
full matrix at once. Reading the matrix by chunks and append to an HDF5 file will 
be memory efficient. 

We also provide the utility to read in subset of a large matrix in HDF5 file as 
`SummarizedExperiment` object by chunks/indexing.
```{r extract_modz, eval=FALSE}
gctx="./data/GSE92742_Broad_LINCS_Level5_COMPZ.MODZ_n473647x12328.gctx"
gctx2h5(gctx, cid=meta42_filter$sig_id, new_cid=meta42_filter$pert_cell_factor,
        h5file="./data/lincs.h5", chunksize=5000, overwrite=TRUE)
se <- readHDF5chunk(h5file="./data/lincs.h5", colindex=1:5000)
```

# `lincs_expr` signature database

The `lincs_expr` database contains mean gene expression values 
from 5,925 compound treatment samples in 30 cells (38,824 signatures in total). 
It can be loaded through the `AnnotationHub` interface
```{r lincs_expr, eval=FALSE}
library(AnnotationHub)
ah <- AnnotationHub()
qr <- query(ah, c("signatureSearchData", "lincs"))
lincs_expr <- load_sigdb("AH69081","AH69082","lincs_expr")
```

## Generate the `lincs_expr` database from the original resources
The original LINCS Level3 expression database was downloaded at [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742). 
The downloaded `gctx` file was processed and saved as an HDF5 file.

### Download the original LINCS Level3 datasets at GEO 

Download the following files from [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92742):

+ GSE92742_Broad_LINCS_Level3_INF_mlr12k_n1319138x12328.gctx.gz
+ GSE92742_Broad_LINCS_gene_info.txt.gz
+ GSE92742_Broad_LINCS_inst_info.txt.gz

Unzip the downloaded files to the `data` directory under the present working 
directory of the user’s R session.

The LINCS Level3 signatures represent normalized expression intensity values of 
compound treatment samples at different concentration and time in different cells, 
including replicates.

### Filter signatures 

Filter lincs level3 signatures at specific concentration and treatment time 
```{r filter_expr, eval=FALSE}
library(readr)
inst42 <- read_tsv("./data/GSE92742_Broad_LINCS_inst_info.txt") 
inst42_filter <- inst_filter(inst42, dose=10, dose_unit="um", 
                             time=24, time_unit="h") # 169,795 X 13
```

### Calculate mean expression value and write the expression matrix to HDF5 file

Calculate mean expression values of replicated samples that are treated by the same
compound in the same cell type with selected concentration and treatment time.
Then write the mean expression matrix to an HDF5 file, which is the `lincs_expr`
database
```{r extract_expr, eval=FALSE}
meanExpr2h5(gctx="./data/GSE92742_Broad_LINCS_Level3_INF_mlr12k_n1319138x12328.gctx",
            inst=inst42_filter, h5file="./data/lincs_expr.h5") # 12328 X 38824
```

# Other datasets
This annotation package also contains other intermediate datasets used for
functionality in the `signatureSearch` software package, 
such as getting targets of query drugs in [DrugBank](https://www.drugbank.ca/), 
[CLUE](https://clue.io/) and [STITCH](http://stitch.embl.de/) databases, 
conducting GO enrichment analysis or computing WTCS p-values or tau scores of the
`gess_lincs` method in the `signatureSearch` package.

